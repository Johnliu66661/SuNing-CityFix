<!doctype html>
<html lang="{{ 'zh-CN' if current_locale.startswith('zh') else 'en' }}">
<head>
  <meta charset="utf-8" />
  <title>{{ 'SuNing CityFix Â· åŸå¸‚æ™ºä¿®ç³»ç»Ÿ' if current_locale.startswith('zh') else 'SuNing CityFix Â· Smart Urban Repair System' }}</title>
<link rel="icon" href="/static/img/suning-cityfix-logo.png">
<link rel="apple-touch-icon" href="/static/img/suning-cityfix-logo.png">

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">



  <!-- å‰ç«¯å¯ç”¨çš„ç¿»è¯‘å­—å…¸ï¼ˆç»™çº¯ JS ç”¨ï¼‰ -->
  <script>
    window.I18N = {
      no_data: "{{ _('æš‚æ— æ•°æ®') }}",
      signed_in_as: "{{ _('å·²ç™»å½•ï¼š') }}",
      current_role_label: "{{ _('å½“å‰èº«ä»½ï¼š') }}",
      role_admin: "{{ _('ç®¡ç†å‘˜') }}",
      role_maintainer: "{{ _('ç»´æŠ¤å‘˜') }}",
      role_user: "{{ _('ç”¨æˆ·') }}",
      unit_day: "{{ _('å¤©') }}",
      unit_hour: "{{ _('å°æ—¶') }}",
      status: "{{ _('çŠ¶æ€') }}",
      type_contains: "{{ _('ç±»å‹åŒ…å«') }}",
      desc_contains: "{{ _('æè¿°åŒ…å«') }}",
      created: "{{ _('åˆ›å»ºæ—¶é—´') }}",
      updated: "{{ _('æ›´æ–°æ—¶é—´') }}",
      sort_field: "{{ _('æ’åºå­—æ®µ') }}",
      sort_order: "{{ _('æ’åºæ–¹å¼') }}",
      apply_filters: "{{ _('åº”ç”¨ç­›é€‰') }}",
    };
  </script>

  <!-- å…¨å±€æ ·å¼ -->
  <link rel="stylesheet" href="/static/css/style.css" />

  <!-- Leaflet æ ·å¼ï¼ˆå«æœ¬åœ°å›é€€ï¼‰ -->
  <link rel="preload" as="style" href="https://cdn.staticfile.org/leaflet/1.9.4/leaflet.css">
  <link id="leaflet-css" rel="stylesheet" href="https://cdn.staticfile.org/leaflet/1.9.4/leaflet.css"
        onerror="this.href='/static/leaflet/leaflet.css'"/>

  <!-- ä¸»é¡µå°‘é‡è¡¥å……æ ·å¼ï¼ˆä¸æ”¹ä½ çš„ style.css æ–‡ä»¶ï¼‰ -->
  <style>
    .site-nav{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand{ font-weight:800; font-size:18px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
    .nav-links{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav-links a{ text-decoration:none; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:999px; }
    .nav-links a:hover{ background:#f3f6fb; }

    .hero{
      position: relative; overflow: hidden; border-radius: var(--radius-lg);
      background: radial-gradient(1000px 400px at 10% -10%, #e9f2ff 0%, transparent 60%),
                  radial-gradient(800px 320px at 120% 10%, #e6fff5 0%, transparent 60%),
                  linear-gradient(180deg, #f7fbff, #ffffff);
      margin-bottom:14px; padding: 20px;
    }
    .hero-grid{ display:grid; grid-template-columns: 1.4fr 1fr; gap:18px; align-items:center; }
    @media (max-width: 900px){ .hero-grid{ grid-template-columns:1fr; } }
    .hero-copy h1{ font-size: clamp(26px, 3.6vw, 40px); margin:8px 0; }
    .hero-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#f8fafc;
      font-size:13px; color:var(--muted); margin-bottom:8px;
    }
    .hero-illus{
      height: 240px; border:1px dashed var(--border); border-radius: var(--radius-lg);
      background: linear-gradient(135deg, #eef3ff, #f7fcff);
      display:flex; align-items:center; justify-content:center; color:#6b7280; font-weight:700;
    }

    .features{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:14px; }
    .feature{ padding:14px; border:1px solid var(--border); border-radius:var(--radius); background:var(--panel); box-shadow: var(--shadow); }
    .feature h4{ display:flex; align-items:center; gap:8px; margin:0 0 6px; }

    .steps{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:14px; margin-top:14px; }
    .step{ padding:14px; border:1px dashed var(--border); border-radius: var(--radius); background:#f8fafc; }
    .step b{ font-size:22px; margin-right:8px; color: var(--primary); }

    .stats{ display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:14px; margin-top:14px; }
    .stat{ text-align:center; padding:18px; border:1px solid var(--border); border-radius:var(--radius); background:var(--panel); box-shadow: var(--shadow); }
    .stat .num{ font-size:28px; font-weight:900; color: var(--primary); }

    .foot{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; font-size:13px; color:var(--muted); }
    .reveal{ opacity:0; transform: translateY(8px); transition: opacity .5s ease, transform .5s ease; }
    .reveal.in{ opacity:1; transform:none; }

    .link-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .link-row a{ font-size:13px; color:var(--primary); text-decoration:none; }
    .link-row a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="section">
      <div class="site-nav">
        <div class="brand">
  <img class="brand-logo" src="/static/img/suning-cityfix-logo.png" alt="SuNing CityFix logo" />
  <span class="brand-name">
    {{ 'SuNing CityFix Â· åŸå¸‚æ™ºä¿®ç³»ç»Ÿ' if current_locale.startswith('zh') else 'SuNing CityFix Â· Smart Urban Repair System' }}
  </span>
</div>

        <nav class="nav-links">
          <a href="#home"  id="link-home"  data-nav="home">{{ _('é¦–é¡µ') }}</a>
          <a href="#app"   id="link-app"   data-nav="app"  class="hidden">{{ _('è¿›å…¥ç³»ç»Ÿ') }}</a>
          <a href="#login" id="link-login" data-nav="login">{{ _('ç™»å½•/æ³¨å†Œ') }}</a>
          {% include '_lang_switch.html' %}
        </nav>
      </div>
    </header>

    <!-- ä¸»é¡µ -->
    <section id="home-section" class="section reveal">
      <div class="hero">
        <div class="hero-grid">
          <div class="hero-copy">
            <span class="hero-badge">{{ _('å¯é  Â· é«˜æ•ˆ Â· å¯è§†åŒ–') }}</span>
<h1>
  {{ 'SuNing CityFix Â· åŸå¸‚æ™ºä¿®ç³»ç»Ÿ' if current_locale.startswith('zh') else 'SuNing CityFix Â· Smart Urban Repair System' }}
</h1>

            <p>{{ _('ä»å±…æ°‘ä¸ŠæŠ¥åˆ°ç»´æŠ¤é—­ç¯ï¼Œæ”¯æŒåœ°å›¾å®šä½ã€å·¥å•æµè½¬ã€æƒé™æ§åˆ¶ä¸å›¾ç‰‡ç•™å­˜ã€‚å¼€ç®±å³ç”¨ï¼Œè½»é‡éƒ¨ç½²ã€‚') }}</p>

            <!-- æœªç™»å½• CTA -->
            <div class="hero-cta" id="cta-guest" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;">
              <a class="btn btn-primary" href="#login" data-nav="login">{{ _('ç™»å½• / æ³¨å†Œ') }}</a>
            </div>

            <!-- å·²ç™»å½• CTA -->
            <div class="hero-cta hidden" id="cta-authed" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:6px;">
              <span class="hero-badge" id="badge-logged">{{ _('å·²ç™»å½•') }}</span>
              <a class="btn btn-primary" href="#app" data-nav="app">{{ _('è¿›å…¥ç³»ç»Ÿ') }}</a>
            </div>
          </div>

          <div class="hero-illus mesh-bg" aria-hidden="true"></div>
          <!-- è½»é‡æ’ç”» -->
          <svg viewBox="0 0 560 240" width="100%" height="100%" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#60a5fa"/>
                <stop offset="1" stop-color="#22c55e"/>
              </linearGradient>
              <radialGradient id="dot" r="1">
                <stop offset="0" stop-color="#fff" stop-opacity="1"/>
                <stop offset="1" stop-color="#fff" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <g opacity="0.15" stroke="url(#g1)">
              <path d="M0 40H560 M0 80H560 M0 120H560 M0 160H560 M0 200H560" />
              <path d="M40 0V240 M80 0V240 M120 0V240 M160 0V240 M200 0V240 M240 0V240
                       M280 0V240 M320 0V240 M360 0V240 M400 0V240 M440 0V240 M480 0V240 M520 0V240" />
            </g>
            <path d="M0,170 C100,120 180,210 280,160 C380,110 460,190 560,140" fill="none" stroke="url(#g1)" stroke-width="3" opacity=".9"/>
            <path d="M0,115 C110,95 180,140 280,115 C390,90 470,130 560,105" fill="none" stroke="url(#g1)" stroke-width="2" opacity=".6"/>
            <g opacity=".9">
              <circle cx="120" cy="120" r="2.6" fill="#fff"/>
              <circle cx="220" cy="90"  r="2.2" fill="#fff"/>
              <circle cx="310" cy="150" r="2.4" fill="#fff"/>
              <circle cx="420" cy="110" r="2.6" fill="#fff"/>
              <circle cx="500" cy="140" r="2.2" fill="#fff"/>
            </g>
            <g opacity=".35">
              <circle cx="220" cy="90"  r="40" fill="url(#dot)"/>
              <circle cx="420" cy="110" r="44" fill="url(#dot)"/>
            </g>
          </svg>
        </div>
      </div>

      <div class="features reveal extra-content">
        <div class="feature"><h4>ğŸ—ºï¸ {{ _('åœ°å›¾å®šä½') }}</h4><p>{{ _('Leaflet + OSMï¼Œæ”¯æŒåæ ‡ä¸ç…§ç‰‡ EXIF è‡ªåŠ¨è·å–ã€‚') }}</p></div>
        <div class="feature"><h4>ğŸ” {{ _('æƒé™æ¸…æ™°') }}</h4><p>{{ _('ç®¡ç†å‘˜ / ç»´æŠ¤å‘˜ / ç”¨æˆ·å¤šè§’è‰²ï¼ŒJWT é‰´æƒã€‚') }}</p></div>
        <div class="feature"><h4>âš¡ {{ _('æµç¨‹é—­ç¯') }}</h4><p>{{ _('ä¸ŠæŠ¥â€”æŒ‡æ´¾â€”å®Œå·¥å›¾â€”å½’æ¡£ï¼Œäº‹ä»¶æ—¶é—´çº¿å¯è¿½æº¯ã€‚') }}</p></div>
        <div class="feature"><h4>ğŸ“¦ {{ _('è½»æ¾éƒ¨ç½²') }}</h4><p>{{ _('Flask + SQLite å¼€ç®±å³ç”¨ï¼Œå¯å‡çº§åˆ°ç”Ÿäº§æ•°æ®åº“ã€‚') }}</p></div>
      </div>

      <div class="steps reveal extra-content">
        <div class="step"><p><b>1</b> {{ _('ç™»å½•/æ³¨å†Œåå¡«å†™é—®é¢˜ã€ä½ç½®ä¸ç…§ç‰‡ï¼Œä¸€é”®æäº¤ã€‚') }}</p></div>
        <div class="step"><p><b>2</b> {{ _('ç®¡ç†ç«¯æŒ‡æ´¾ç»´æŠ¤å‘˜ï¼Œå®æ—¶è·Ÿè¸ªçŠ¶æ€å˜åŒ–ã€‚') }}</p></div>
        <div class="step"><p><b>3</b> {{ _('ç»´æŠ¤å®Œæˆä¸Šä¼ å®Œå·¥å›¾ï¼Œè‡ªåŠ¨å½’æ¡£ã€‚') }}</p></div>
      </div>

      <div class="stats reveal extra-content">
        <div class="stat"><div class="num" data-count-to="1280">0</div><div class="small">{{ _('ç´¯è®¡æŠ¥ä¿®') }}</div></div>
        <div class="stat"><div class="num" data-count-to="96">0</div><div class="small">{{ _('å®Œæˆç‡ï¼ˆ%ï¼‰') }}</div></div>
        <div class="stat"><div class="num" data-count-to="3.2">0</div><div class="small">{{ _('å¹³å‡å¤„ç†å¤©æ•°') }}</div></div>
      </div>
    </section>

    <!-- å¹³å°äº®ç‚¹ -->
    <div class="highlights section-mini reveal extra-content">
      <div class="hi-grid">
        <article class="hi card">
          <h4>ğŸ“ {{ _('å¼€ç®±å³ç”¨çš„åœ°å›¾ä¸ŠæŠ¥') }}</h4>
          <p>{{ _('ä¸€é”®è·å–åæ ‡ä¸ EXIFï¼Œæ‰‹æœºç«¯è‡ªé€‚åº”ï¼Œç°åœºå³å¯æäº¤ã€‚') }}</p>
        </article>
        <article class="hi card">
          <h4>ğŸ§­ {{ _('å…¨è§’è‰²é—­ç¯') }}</h4>
          <p>{{ _('ç®¡ç†å‘˜æŒ‡æ´¾ã€ç»´æŠ¤å‘˜å›æ‰§ã€å±…æ°‘å›è®¿ï¼Œæ—¶é—´çº¿å¯è¿½æº¯ã€‚') }}</p>
        </article>
        <article class="hi card">
          <h4>ğŸ§± {{ _('è½»é‡å¯æ‰©å±•') }}</h4>
          <p>{{ _('Flask + SQLite èµ·æ­¥ï¼Œæ”¯æŒ JWTã€S3/OSSã€Postgres ç­‰å‡çº§ã€‚') }}</p>
        </article>
      </div>
    </div>

    <!-- å¿«é€Ÿå…¥é—¨ -->
    <div class="quickstart section-mini reveal extra-content" id="quickstart">
      <h3 class="uc-title">{{ _('å¿«é€Ÿå…¥é—¨') }}</h3>
      <ol class="qs-steps">
        <li><b>1.</b> <a class="link" href="#register" data-nav="register">{{ _('æ³¨å†Œè´¦å·') }}</a> {{ _('æˆ–') }} <a class="link" href="#login" data-nav="login">{{ _('ç™»å½•') }}</a></li>
        <li><b>2.</b> {{ _('åœ¨â€œæäº¤æŠ¥ä¿®â€é‡Œå¡«å†™ç±»å‹/åæ ‡/ç…§ç‰‡å¹¶æäº¤') }}</li>
        <li><b>3.</b> {{ _('ç®¡ç†ç«¯æŒ‡æ´¾ç»´æŠ¤å‘˜å¹¶è·Ÿè¸ªå·¥å•ç›´è‡³å®Œç»“') }}</li>
      </ol>
      <div class="qs-actions">
        <a class="btn btn-primary" href="#login" data-nav="login">{{ _('ç«‹å³å¼€å§‹') }}</a>
        <a class="btn btn-outline" href="#app" data-nav="app">{{ _('æŸ¥çœ‹æ¼”ç¤º') }}</a>
      </div>
    </div>

    <!-- ä»‹ç»è§†é¢‘ -->
<div class="video-section section-mini reveal extra-content">
  <div class="video-card">
    <div class="video-wrap">
      <button class="video-play" aria-label="{{ _('æ’­æ”¾/æš‚åœ') }}">â–¶</button>
      <video id="intro-video" preload="none" playsinline webkit-playsinline
             poster="/static/img/intro-poster.jpg">
        <source src="/static/media/intro.mp4" type="video/mp4">
      </video>
    </div>

    <ul id="video-playlist" class="video-list" aria-label="{{ _('è§†é¢‘åˆ—è¡¨') }}">
      <li class="is-active" role="button" tabindex="0"
          data-src="/static/media/intro.mp4"
          data-type="video/mp4"
          data-poster="/static/img/intro-poster.jpg">
        {{ _('å¹³å°ä»‹ç»') }}
      </li>
      <li role="button" tabindex="0"
          data-src="/static/media/tour.mp4"
          data-type="video/mp4"
          data-poster="/static/img/tour-poster.jpg">
        {{ _('ç°åœºæ¼”ç¤º') }}
      </li>
    </ul>
  </div>
</div>


    <!-- ç”¨ä¾‹è½®æ’­ -->
    <div class="usecases section-mini reveal extra-content" aria-labelledby="cases-title">
      <h3 id="cases-title" class="uc-title">{{ _('å…¸å‹åœºæ™¯') }}</h3>
      <div class="uc-carousel" id="case-carousel" aria-live="polite">
        <div class="uc-track">
          <article class="slide card">
            <h4>{{ _('å°åŒºè®¾æ–½') }}</h4>
            <p>{{ _('ä½æˆ·æ‹ç…§ä¸ŠæŠ¥è·¯ç¯ã€äº•ç›–ã€ç”µæ¢¯ç­‰ï¼Œç‰©ä¸šå¿«é€Ÿæ´¾å·¥ã€‚') }}</p>
          </article>
          <article class="slide card">
            <h4>{{ _('å›­åŒºç»´ä¿') }}</h4>
            <p>{{ _('å›­åŒºä¿ä¿®ç»Ÿä¸€è¿›ç³»ç»Ÿï¼Œç»´ä¿å•†æŒ‰ SLA å“åº”ã€‚') }}</p>
          </article>
          <article class="slide card">
            <h4>{{ _('åŸå¸‚éƒ¨ä»¶') }}</h4>
            <p>{{ _('å¸‚æ”¿çƒ­çº¿æµå…¥å·¥å•ã€åœ°å›¾å®šä½ã€å¤šéƒ¨é—¨ååŒé—­ç¯ã€‚') }}</p>
          </article>
          <article class="slide card">
            <h4>{{ _('æ ¡å›­åå‹¤') }}</h4>
            <p>{{ _('å®¿èˆ/æ•™å­¦æ¥¼æŠ¥ä¿®æ ‡å‡†åŒ–ï¼Œæš‘æœŸé›†ä¸­å¤„ç†æœ‰æ®å¯æŸ¥ã€‚') }}</p>
          </article>
        </div>
        <div class="uc-dots" role="tablist" aria-label="{{ _('åˆ‡æ¢æ¡ˆä¾‹') }}">
          <button class="dot is-active" data-slide="0" role="tab" aria-selected="true"><span class="sr-only">1</span></button>
          <button class="dot" data-slide="1" role="tab" aria-selected="false"><span class="sr-only">2</span></button>
          <button class="dot" data-slide="2" role="tab" aria-selected="false"><span class="sr-only">3</span></button>
          <button class="dot" data-slide="3" role="tab" aria-selected="false"><span class="sr-only">4</span></button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·è¯„ä»· -->
    <div class="testimonials section-mini reveal extra-content">
      <div class="t-grid">
        <figure class="t card">
          <blockquote>â€œ{{ _('æŠ¥ä¿®æ•ˆç‡æ˜¾è‘—æå‡ï¼Œå¹³å‡å¤„ç†å¤©æ•°ä» 7 å¤©é™åˆ° 3 å¤©ã€‚') }}â€</blockquote>
          <figcaption>â€” {{ _('æ–°åŸç‰©ä¸šè¿ç»´ç»ç†') }}</figcaption>
        </figure>
        <figure class="t card">
          <blockquote>â€œ{{ _('æ‰‹æœºä¸€æ‹å³æŠ¥ï¼Œå®šä½å‡†ç¡®ï¼Œå±…æ°‘æ»¡æ„åº¦æ›´é«˜äº†ã€‚') }}â€</blockquote>
          <figcaption>â€” {{ _('æ»¨æ²³è¡—é“ç½‘æ ¼å‘˜') }}</figcaption>
        </figure>
        <figure class="t card">
          <blockquote>â€œ{{ _('æµç¨‹é€æ˜å¯è¿½æº¯ï¼Œç»©æ•ˆè€ƒæ ¸ä¸ SLA ä¸€ä¸€å¯¹åº”ã€‚') }}â€</blockquote>
          <figcaption>â€” {{ _('å›­åŒºç®¡å§”ä¼šä¿¡æ¯ç§‘') }}</figcaption>
        </figure>
      </div>
    </div>

    <!-- ç»“å°¾ CTA æ¨ªå¹… -->
    <div class="cta-band reveal extra-content">
      <div class="cta-inner">
        <h3>{{ _('é©¬ä¸Šè¯•ç”¨ Smart Urban System') }}</h3>
        <p class="small">{{ _('è½»é‡éƒ¨ç½² Â· æ•°æ®å¯æ§ Â· æ”¯æŒäºŒæ¬¡å¼€å‘') }}</p>
        <div class="cta-actions">
          <a class="btn btn-primary btn-lg" href="#login" data-nav="login">{{ _('å…è´¹æ³¨å†Œ') }}</a>
          <a class="btn btn-outline btn-lg" href="#app" data-nav="app">{{ _('è¿›å…¥æ¼”ç¤º') }}</a>
        </div>
      </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œ -->
    <section id="login-section" class="section hidden reveal">
      <h2>{{ _('èº«ä»½è®¤è¯') }}</h2>

      <div class="auth-grid">
        <!-- æ™®é€šç”¨æˆ·ç™»å½• -->
        <div id="user-login-section" class="auth-section card">
          <form id="user-login-form">
            <label>{{ _('ç”¨æˆ·å') }} <input id="user-username" type="text" required></label>
            <label>{{ _('å¯†ç ') }} <input id="user-password" type="password" required></label>
            <button type="submit" class="btn btn-primary">{{ _('ç™»å½•') }}</button>
            <div id="user-login-message" class="message" style="display:none"></div>
          </form>
          <div class="link-row">
            <a href="#maint" data-nav="maint">{{ _('ç»´æŠ¤å‘˜å…¥å£') }}</a>
            <a href="#admin" data-nav="admin">{{ _('ç®¡ç†å‘˜å…¥å£') }}</a>
            <a href="#register" data-nav="register">{{ _('æ³¨å†Œè´¦å·') }}</a>
          </div>
        </div>

        <!-- ç»´æŠ¤å‘˜ç™»å½• -->
        <div id="maintainer-login-section" class="auth-section card hidden">
          <form id="maintainer-login-form">
            <label>{{ _('ç»´æŠ¤å‘˜è´¦å·') }} <input id="maint-username" type="text" required></label>
            <label>{{ _('å¯†ç ') }} <input id="maint-password" type="password" required></label>
            <button type="submit" class="btn btn-primary">{{ _('ç™»å½•ç»´æŠ¤å‘˜') }}</button>
            <div id="maint-login-message" class="message" style="display:none"></div>
          </form>
          <div class="link-row"><a href="#login" data-nav="login">{{ _('è¿”å›ç”¨æˆ·ç™»å½•') }}</a></div>
          <p class="small">{{ _('æç¤ºï¼šç®¡ç†å‘˜éœ€å…ˆæŠŠè¯¥ç”¨æˆ·è§’è‰²è®¾ä¸º') }} <code>maintainer</code>ã€‚</p>
        </div>

        <!-- ç®¡ç†å‘˜ç™»å½• -->
        <div id="admin-login-section" class="auth-section card hidden">
          <form id="admin-login-form">
            <label>{{ _('ç®¡ç†å‘˜è´¦å·') }} <input id="admin-username" type="text" required></label>
            <label>{{ _('å¯†ç ') }} <input id="admin-password" type="password" required></label>
            <button type="submit" class="btn btn-primary">{{ _('ç™»å½•ç®¡ç†å‘˜') }}</button>
            <div id="admin-login-message" class="message" style="display:none"></div>
          </form>
          <div class="link-row"><a href="#login" data-nav="login">{{ _('è¿”å›ç”¨æˆ·ç™»å½•') }}</a></div>
          <p class="small">{{ _('é»˜è®¤ï¼šadmin / adminpass') }}</p>
        </div>

        <!-- ç”¨æˆ·æ³¨å†Œ -->
        <div id="user-register-section" class="auth-section card hidden">
          <form id="user-register-form">
            <label>{{ _('ç”¨æˆ·å') }} <input id="reg-username" type="text" required></label>
            <label>{{ _('å¯†ç ') }} <input id="reg-password" type="password" required></label>
            <label>{{ _('é‚®ç®±') }} <input id="reg-email" type="email" placeholder="{{ _('å¯é€‰') }}"></label>
            <button type="submit" class="btn btn-primary">{{ _('æ³¨å†Œ') }}</button>
            <div id="register-message" class="message" style="display:none"></div>
          </form>
          <div class="link-row"><a href="#login" data-nav="login">{{ _('è¿”å›ç”¨æˆ·ç™»å½•') }}</a></div>
        </div>
      </div>
    </section>

    <!-- ç³»ç»Ÿé¡µ -->
    <section id="main-app-section" class="section hidden reveal">
      <div class="header">
        <div class="whoami">
          <span>ğŸ‘¤</span><span id="whoami-text">{{ _('æœªç™»å½•') }}</span>
        </div>
        <button id="logout-button" class="btn" type="button">{{ _('é€€å‡ºç™»å½•') }}</button>
      </div>

      <!-- ç»´æŠ¤å‘˜å·¥å…·ï¼ˆæŒ‰éœ€æ˜¾ç¤ºï¼‰ -->
      <div id="maintainer-tools" class="section hidden" style="display:none;">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="assigned-only" checked>
          {{ _('åªçœ‹æŒ‡æ´¾ç»™æˆ‘çš„å·¥å•') }}
        </label>
        <small>{{ _('ç®¡ç†å‘˜å¯åœ¨æ¯æ¡å¡ç‰‡å†…è¾“å…¥ç»´æŠ¤å‘˜ç”¨æˆ·åå¹¶â€œæŒ‡æ´¾â€ã€‚') }}</small>
      </div>

      <!-- ç®¡ç†å‘˜å·¥å…·ï¼ˆæŒ‰éœ€æ˜¾ç¤ºï¼‰ -->
      <div id="admin-tools" class="section" style="display:none;">
        <h4>{{ _('ç®¡ç†å‘˜å·¥å…·') }}</h4>
        <div class="card" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <label>{{ _('ç”¨æˆ·å') }}
            <input id="set-maint-username" type="text" placeholder="{{ _('è¾“å…¥å·²æœ‰ç”¨æˆ·å') }}" />
          </label>
          <button id="set-maint-btn" class="btn btn-primary" type="button">{{ _('è®¾ä¸ºç»´æŠ¤å‘˜') }}</button>
          <div id="set-maint-msg" class="message" style="display:none"></div>
        </div>
        <p class="small" style="color:#6b7280;">{{ _('æç¤ºï¼šç›®æ ‡ç”¨æˆ·éœ€å·²æ³¨å†Œï¼›è®¾ç½®æˆåŠŸåè¯¥ç”¨æˆ·éœ€é‡æ–°ç™»å½•ã€‚') }}</p>
      </div>

      <!-- è¿è¡Œä»ªè¡¨ç›˜ -->
      <section id="dashboard" class="section reveal" aria-labelledby="dash-title">
        <div class="dash-head">
          <div>
            <h2 id="dash-title">{{ _('è¿è¡Œä»ªè¡¨ç›˜') }}</h2>
            <div id="dash-updated" class="small" aria-live="polite">{{ _('æ›´æ–°äº â€”â€”') }}</div>
          </div>
          <div class="chip-row" role="group" aria-label="{{ _('æ—¶é—´èŒƒå›´') }}">
            <button class="chip" data-range="7d"  aria-pressed="true">{{ _('è¿‘ 7 å¤©') }}</button>
            <button class="chip" data-range="30d" aria-pressed="false">{{ _('è¿‘ 30 å¤©') }}</button>
            <button class="chip" data-range="90d" aria-pressed="false">{{ _('è¿‘ 90 å¤©') }}</button>
          </div>
        </div>

        <!-- KPI 6 å¡ -->
        <div class="kpi-grid" id="kpi-grid">
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('æŠ¥ä¿®é‡') }}</div>
            <div class="kpi-value" id="kpi-tickets">â€”</div>
            <div class="kpi-trend" id="kpi-tickets-trend"><span class="sr-only">{{ _('ç¯æ¯”') }}</span>â€”</div>
            <svg class="spark" id="spark-tickets" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('é¦–æ¬¡å“åº”ä¸­ä½æ•°') }}</div>
            <div class="kpi-value" id="kpi-frt">â€”</div>
            <div class="kpi-trend" id="kpi-frt-trend">â€”</div>
            <svg class="spark" id="spark-frt" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('ä¿®å¤ä¸­ä½æ•°') }}</div>
            <div class="kpi-value" id="kpi-mttr">â€”</div>
            <div class="kpi-trend" id="kpi-mttr-trend">â€”</div>
            <svg class="spark" id="spark-mttr" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('SLA è¾¾æˆç‡') }}</div>
            <div class="kpi-value" id="kpi-sla">â€”</div>
            <div class="kpi-trend" id="kpi-sla-trend">â€”</div>
            <svg class="spark" id="spark-sla" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('æœªç»“å·¥å•') }}</div>
            <div class="kpi-value" id="kpi-open">â€”</div>
            <div class="kpi-trend" id="kpi-open-trend">â€”</div>
            <svg class="spark" id="spark-open" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
          <div class="kpi-card card">
            <div class="kpi-name">{{ _('é€¾æœŸå·¥å•') }}</div>
            <div class="kpi-value" id="kpi-overdue">â€”</div>
            <div class="kpi-trend" id="kpi-overdue-trend">â€”</div>
            <svg class="spark" id="spark-overdue" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"></svg>
          </div>
        </div>

        <!-- ä¸­åŒº -->
        <div class="dash-grid">
          <section class="chart-card card col-8" aria-labelledby="trend-title">
            <h3 id="trend-title">{{ _('æŠ¥ä¿®ä¸æ—¶é•¿è¶‹åŠ¿') }}</h3>
            <svg id="line-trend" viewBox="0 0 600 240" preserveAspectRatio="none" role="img" aria-label="{{ _('æœ€è¿‘è¶‹åŠ¿') }}"></svg>
          </section>

          <aside class="chart-card card col-4" aria-labelledby="alerts-title">
            <h3 id="alerts-title">{{ _('å‘Šè­¦') }}</h3>
            <div id="alerts" class="alert-list" aria-live="polite">
              <div class="skeleton" style="height:60px;"></div>
              <div class="skeleton" style="height:60px;"></div>
            </div>
          </aside>

          <section class="chart-card card col-8" aria-labelledby="types-title">
            <h3 id="types-title">{{ _('ç±»å‹åˆ†å¸ƒ') }}</h3>
            <div id="types-bars" class="type-bars"></div>
          </section>

          <section class="table-wrap col-12" aria-labelledby="latest-title">
            <h3 id="latest-title" style="padding:10px 12px; margin:0;">{{ _('æœ€æ–°å·¥å•ï¼ˆç¤ºä¾‹ï¼‰') }}</h3>
            <table class="table" aria-describedby="latest-title">
              <thead>
                <tr>
                  <th>{{ _('ç¼–å·') }}</th>
                  <th>{{ _('ç±»å‹') }}</th>
                  <th>{{ _('çŠ¶æ€') }}</th>
                  <th>{{ _('åŒºåŸŸ') }}</th>
                  <th>SLA</th>
                </tr>
              </thead>
              <tbody id="latest-body">
                <tr><td colspan="5"><div class="skeleton" style="height:32px;"></div></td></tr>
                <tr><td colspan="5"><div class="skeleton" style="height:32px;"></div></td></tr>
              </tbody>
            </table>
          </section>
        </div>
      </section>

      <h3>{{ _('æäº¤æŠ¥ä¿®') }}</h3>
      <form id="report-form" class="card">
        <label style="display:flex;align-items:center;gap:8px;margin:6px 0 4px;">
  <input type="checkbox" id="auto-ai" checked>
  <span>è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡å¹¶å¡«å†™ç±»å‹ä¸æè¿°</span>
</label>
<div id="ai-hint" class="message" style="display:none;"></div>

        <label>{{ _('æŠ¥ä¿®ç±»å‹') }} <input type="text" name="report_type" placeholder="{{ _('å¦‚ï¼šè·¯ç¯ã€ç”µæ¢¯ã€ä¾›æ°´...') }}" required></label>
        <label>{{ _('æè¿°') }} <textarea name="description" placeholder="{{ _('è¯·æè¿°é—®é¢˜...') }}" required></textarea></label>
        <div class="grid-2">
          <label>{{ _('çº¬åº¦') }} <input type="number" name="latitude" step="0.000001" required></label>
          <label>{{ _('ç»åº¦') }} <input type="number" name="longitude" step="0.000001" required></label>
        </div>
        <label>{{ _('ç°åœºç…§ç‰‡ï¼ˆå¯é€‰ï¼‰') }}<input type="file" name="photo" accept="image/*"></label>
        <button type="submit" class="btn btn-primary">{{ _('æäº¤æŠ¥ä¿®') }}</button>
        <div id="report-message" class="message" style="display:none"></div>
      </form>

      <!-- æŠ¥ä¿®åŒºï¼šç­›é€‰ï¼ˆå¡ç‰‡ï¼‰ + åœ°å›¾ï¼ˆåœ¨ä¸Šï¼‰ + åˆ—è¡¨ï¼ˆå¡ç‰‡ï¼Œå«åˆ†é¡µï¼‰ -->
      <div id="reports-layout" class="reports-layout">

        <!-- ç­›é€‰æ¡ï¼šå¡ç‰‡ -->
        <div id="filter-sort-controls" class="card">
          <div class="toolbar">
            <div class="group">
              <label for="filter-status">{{ _('çŠ¶æ€') }}</label>
              <select id="filter-status">
                <option value="All">{{ _('å…¨éƒ¨') }}</option>
                <option value="Pending">{{ _('å¾…å¤„ç†') }}</option>
                <option value="In Progress">{{ _('å¤„ç†ä¸­') }}</option>
                <option value="Completed">{{ _('å·²å®Œæˆ') }}</option>
                <option value="Rejected">{{ _('å·²æ‹’ç»') }}</option>
              </select>
            </div>
            <div class="group">
              <label for="filter-report-type">{{ _('ç±»å‹åŒ…å«') }}</label>
              <input id="filter-report-type" type="text" placeholder="{{ _('ä¾‹å¦‚ï¼šè·¯ç¯') }}">
            </div>
            <div class="group">
              <label for="search-description">{{ _('æè¿°åŒ…å«') }}</label>
              <input id="search-description" type="text" placeholder="{{ _('å…³é”®è¯') }}">
            </div>
            <div class="group">
              <label for="sort-by">{{ _('æ’åºå­—æ®µ') }}</label>
              <select id="sort-by">
                <option value="created_at" selected>{{ _('åˆ›å»ºæ—¶é—´') }}</option>
                <option value="updated_at">{{ _('æ›´æ–°æ—¶é—´') }}</option>
                <option value="status">{{ _('çŠ¶æ€') }}</option>
              </select>
            </div>
            <div class="group">
              <label for="sort-order">{{ _('æ’åºæ–¹å¼') }}</label>
              <select id="sort-order">
                <option value="desc" selected>{{ _('é™åº') }}</option>
                <option value="asc">{{ _('å‡åº') }}</option>
              </select>
            </div>

            <div class="group actions">
              <label style="display:flex;align-items:center;gap:8px;margin:0;">
                <input type="checkbox" id="toggle-map" checked> {{ _('æ˜¾ç¤ºåœ°å›¾') }}
              </label>
              <button id="apply-filters-button" class="btn btn-primary btn-lg" type="button">{{ _('åº”ç”¨ç­›é€‰') }}</button>
              <div class="segmented" id="view-toggle" role="tablist" aria-label="{{ _('è§†å›¾åˆ‡æ¢') }}" style="display:none">
                <button data-view="cards" class="active" role="tab" aria-selected="true" type="button">{{ _('å¡ç‰‡') }}</button>
                <button data-view="table" role="tab" aria-selected="false" type="button">{{ _('è¡¨æ ¼') }}</button>
              </div>
            </div>
          </div>
        </div>

        <!-- åœ°å›¾åœ¨ä¸Š -->
        <section id="map-section" class="card map-card">
          <h4 class="list-title">{{ _('é—®é¢˜åœ°å›¾') }}</h4>
          <div id="map"></div>
        </section>

        <!-- æŠ¥ä¿®åˆ—è¡¨è¢«æ¡†èµ·æ¥ï¼Œåº•éƒ¨å†…ç½®åˆ†é¡µ -->
        <section id="list-section" class="card list-card">
          <h4 class="list-title">{{ _('æŠ¥ä¿®åˆ—è¡¨') }}</h4>
          <div id="reports-list"></div>

          <div id="pagination-controls" class="pagination-section hidden">
            <button id="prev-page" class="btn" type="button">{{ _('ä¸Šä¸€é¡µ') }}</button>
            <span id="page-info">{{ _('é¡µç ') }} 1 / 1</span>
            <button id="next-page" class="btn" type="button">{{ _('ä¸‹ä¸€é¡µ') }}</button>
          </div>
        </section>
      </div>
    </section>

<footer class="section foot">
  <div>Â© 2025 SuNing CityFix</div>
      <div class="small">{{ _('Made with Flask Â· Leaflet Â· OSM') }}</div>
    </footer>
  </div>

  <!-- ä½ çš„ä¸šåŠ¡è„šæœ¬ -->
  <script src="/static/js/script.js" defer></script>

  <!-- Ripple æ•ˆæœï¼ˆè½»é‡ï¼‰ -->
  <script>
    (function () {
      const selector = '.btn, button[data-action], #prev-page, #next-page';
      document.addEventListener('click', function (e) {
        const el = e.target.closest(selector);
        if (!el) return;
        const r = document.createElement('span');
        r.className = 'ripple';
        const rect = el.getBoundingClientRect();
        const d = Math.max(rect.width, rect.height);
        r.style.width = r.style.height = d + 'px';
        r.style.left = (e.clientX - rect.left - d / 2) + 'px';
        r.style.top  = (e.clientY - rect.top  - d / 2) + 'px';
        el.appendChild(r);
        setTimeout(() => r.remove(), 700);
      }, { passive: true });
    })();
  </script>

  <!-- è‹±é›„åŒºæŸ”å…‰æ™• -->
  <script>
    (function(){
      const hero = document.querySelector('.hero');
      if(!hero) return;
      function setPos(x, y){
        const r = hero.getBoundingClientRect();
        const mx = ((x - r.left)/r.width * 100).toFixed(2) + '%';
        const my = ((y - r.top)/r.height * 100).toFixed(2) + '%';
        hero.style.setProperty('--mx', mx);
        hero.style.setProperty('--my', my);
      }
      hero.addEventListener('mousemove', e=> setPos(e.clientX, e.clientY), {passive:true});
      hero.addEventListener('touchmove', e=> { const t = e.touches[0]; if(t) setPos(t.clientX, t.clientY); }, {passive:true});
      const r = hero.getBoundingClientRect(); setPos(r.left + r.width*0.3, r.top + r.height*0.22);
    })();
  </script>

  <!-- æ³¨å†Œ Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(console.error);
    }
  </script>

  <!-- app-mode åˆ‡æ¢ & åˆ·æ–°å…œåº• -->
  <script>
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('[data-nav]'); if(!a) return;
      const nav = a.getAttribute('data-nav');
      if (nav === 'app')  document.documentElement.classList.add('app-mode');
      if (nav === 'home' || nav === 'login') document.documentElement.classList.remove('app-mode');
    });
    document.getElementById('logout-button')?.addEventListener('click', ()=>{
      document.documentElement.classList.remove('app-mode');
    });
    function applyModeOnLoad(){
      if (location.hash === '#app') document.documentElement.classList.add('app-mode');
      if (location.hash === '#home' || location.hash === '#login') document.documentElement.classList.remove('app-mode');
    }
    applyModeOnLoad();
    window.addEventListener('hashchange', applyModeOnLoad);
  </script>

  <!-- åœ°å›¾å¢å¼º -->
  <script>
    (function(){
      const mapSection = document.getElementById('map-section');
      const toggle = document.getElementById('toggle-map');
      const listEl = document.getElementById('reports-list');

      function safeInvalidate(){ if (window.__SUS_MAP && __SUS_MAP.invalidateSize) setTimeout(()=>__SUS_MAP.invalidateSize(), 120); }

      if (toggle && mapSection){
        const apply = () => { mapSection.style.display = toggle.checked ? '' : 'none'; if (toggle.checked) safeInvalidate(); };
        toggle.addEventListener('change', apply); apply();
      }

      function getFirstItemLatLng(){
        const first = listEl?.querySelector('.report-item[data-lat][data-lng]');
        if (first) return [parseFloat(first.dataset.lat), parseFloat(first.dataset.lng)];
        return null;
      }

      function tryInitMap(center){
        if (!window.L) return;
        const el = document.getElementById('map');
        if (!el || el._leaflet_id) return;
        const c = center || [31.2304, 121.4737];
        const map = L.map(el).setView(c, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        const marker = L.marker(c).addTo(map);
        window.__SUS_MAP = map;
        window.__SUS_MARKER = marker;
        safeInvalidate();
      }

      const mo = new MutationObserver(()=>{
        const ll = getFirstItemLatLng();
        if (ll && window.__SUS_MAP){
          window.__SUS_MARKER?.setLatLng(ll);
          window.__SUS_MAP.setView(ll, Math.max(__SUS_MAP.getZoom(), 13), {animate:true});
        } else if (ll && !window.__SUS_MAP){
          tryInitMap(ll);
        }
      });
      if (listEl) mo.observe(listEl, {childList:true, subtree:true});

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', ()=>{ tryInitMap(getFirstItemLatLng()); });
      } else {
        tryInitMap(getFirstItemLatLng());
      }

      document.addEventListener('click', (e)=>{
        const card = e.target.closest('#reports-list .report-item[data-lat][data-lng]'); if(!card) return;
        const lat = parseFloat(card.dataset.lat), lng = parseFloat(card.dataset.lng);
        if (Number.isFinite(lat) && Number.isFinite(lng) && window.__SUS_MAP){
          window.__SUS_MARKER?.setLatLng([lat,lng]);
          window.__SUS_MAP.setView([lat,lng], Math.max(__SUS_MAP.getZoom(), 13), {animate:true});
        }
      });

      window.addEventListener('resize', safeInvalidate);
    })();
  </script>

  <!-- ç¦»çº¿æç¤º -->
  <div id="offline-toast" hidden class="card" style="position:fixed;right:16px;bottom:16px;padding:10px 12px;z-index:9999;">
    {{ _('å·²ç¦»çº¿ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œè”ç½‘åè‡ªåŠ¨æäº¤ã€‚') }}
  </div>

  <!-- Dashboard Demo Seederï¼ˆi18n å·²æ¥å…¥ï¼‰ -->
  <script>
  (function(){
    const dash = document.getElementById('dashboard');
    if(!dash) return;

    // éšè¯­è¨€åˆ‡æ¢çš„æ•°å­—æœ¬åœ°åŒ–
    const NUM_LOCALE = '{{ "zh-CN" if current_locale.startswith("zh") else "en-US" }}';
    const fmt = (n)=> Number(n).toLocaleString(NUM_LOCALE);

    // è‹±æ–‡çŠ¶æ€ç  â†’ æœ¬åœ°åŒ–æ˜¾ç¤ºæ–‡æœ¬
    const tStatus = (s)=> ({
      'Pending':     '{{ _("å¾…å¤„ç†") }}',
      'In Progress': '{{ _("å¤„ç†ä¸­") }}',
      'Completed':   '{{ _("å·²å®Œæˆ") }}',
      'Rejected':    '{{ _("å·²æ‹’ç»") }}',
    }[s] || s);

    const set = (id, v)=> { const el = document.getElementById(id); if(el) el.textContent = v; };

    function genSeries(days){
      const tickets = Array.from({length:days}, (_,i)=> Math.max(5, Math.round(25 + Math.sin(i/3)*6 + Math.random()*10)));
      const frtHrs  = Array.from({length:days}, ()=> +(0.6 + Math.random()*1.2).toFixed(2));
      const mttrD   = Array.from({length:days}, ()=> +(1.6 + Math.random()*1.8).toFixed(2));
      const slaPct  = Array.from({length:days}, ()=> Math.min(99, Math.max(88, Math.round(92 + Math.random()*6))));
      const open    = Math.round(40 + Math.random()*50);
      const overdue = Math.round(3 + Math.random()*12);
      const sum = (a)=> a.reduce((s,v)=>s+v,0);
      const median = (a)=> { const b=[...a].sort((x,y)=>x-y); const m=Math.floor(b.length/2); return b.length%2?b[m]:(b[m-1]+b[m])/2; };
      const total = sum(tickets);

      return {
        tickets, frtHrs, mttrD, slaPct, open, overdue, total,
        kpi: {
          tickets: total,
          frt:  median(frtHrs).toFixed(2) + ' ' + (window.I18N?.unit_hour || 'h'),
          mttr: median(mttrD).toFixed(2) + ' ' + (window.I18N?.unit_day  || 'd'),
          sla: Math.round(sum(slaPct)/days) + '%',
          open, overdue
        }
      };
    }

    function drawSpark(svgId, arr){
      const svg = document.getElementById(svgId); if(!svg) return;
      const w = 100, h = 30; svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      const min = Math.min(...arr), max = Math.max(...arr);
      const norm = (v)=> max===min ? h/2 : h - (v-min)/(max-min) * (h-4) - 2;
      const step = w/(arr.length-1 || 1);
      let d = 'M 0 '+norm(arr[0]);
      arr.forEach((v,i)=> { d += ' L ' + (i*step).toFixed(2) + ' ' + norm(v).toFixed(2); });
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const area = document.createElementNS('http://www.w3.org/2000/svg','path');
      area.setAttribute('class','area');
      area.setAttribute('d', d + ` L ${w} ${h} L 0 ${h} Z`);
      svg.appendChild(area);
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      svg.appendChild(path);
    }

    function drawTrend(svgId, arrA, arrB){
      const svg = document.getElementById(svgId); if(!svg) return;
      const W = 600, H = 240; svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      const all = arrA.concat(arrB);
      const min = Math.min(...all), max = Math.max(...all);
      const pad = 14;
      const xStep = (W- pad*2) / (arrA.length-1 || 1);
      const scaleY = (v)=> max===min ? H/2 : H - pad - (v-min)/(max-min) * (H-pad*2);
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const mkPath = (arr)=> {
        let d = `M ${pad} ${scaleY(arr[0]).toFixed(2)}`;
        arr.forEach((v,i)=>{ d += ` L ${ (pad + i*xStep).toFixed(2)} ${ scaleY(v).toFixed(2)}`; });
        return d;
      };
      const p1 = document.createElementNS('http://www.w3.org/2000/svg','path');
      p1.setAttribute('d', mkPath(arrA)); p1.setAttribute('fill','none'); p1.setAttribute('stroke-width','2.2'); p1.setAttribute('stroke','currentColor'); p1.style.opacity = .9;
      const p2 = document.createElementNS('http://www.w3.org/2000/svg','path');
      p2.setAttribute('d', mkPath(arrB)); p2.setAttribute('fill','none'); p2.setAttribute('stroke-width','2'); p2.setAttribute('stroke','#10b981'); p2.style.opacity = .9;
      svg.appendChild(p1); svg.appendChild(p2);
    }

    function trendText(cur, prev){
      if(!prev || prev===0) return 'â€”';
      const pct = ((cur - prev) / prev) * 100;
      const sign = pct >= 0 ? '+' : '';
      const cls = pct >= 0 ? 'trend-up' : 'trend-down';
      return `<span class="${cls}">${sign}${pct.toFixed(1)}%</span>`;
    }

    function render(rangeKey){
      const days = ({'7d':7,'30d':30,'90d':90})[rangeKey] || 7;
      const cur = genSeries(days);
      const prev = genSeries(days);

      const ts = new Date();
      const upd = `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')} ${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}`;
      const updEl = document.getElementById('dash-updated');
      if (updEl) updEl.textContent = `{{ _('æ›´æ–°äº') }} ${upd}`;

      set('kpi-tickets', fmt(cur.kpi.tickets));
      set('kpi-frt',     cur.kpi.frt);
      set('kpi-mttr',    cur.kpi.mttr);
      set('kpi-sla',     cur.kpi.sla);
      set('kpi-open',    fmt(cur.kpi.open));
      set('kpi-overdue', fmt(cur.kpi.overdue));

      const mapSet = (sel, html)=>{ const el=document.querySelector(sel); if(el) el.innerHTML=html; };
      mapSet('#kpi-tickets-trend', trendText(cur.kpi.tickets, prev.kpi.tickets));
      mapSet('#kpi-frt-trend',     trendText(parseFloat(cur.kpi.frt),  parseFloat(prev.kpi.frt)));
      mapSet('#kpi-mttr-trend',    trendText(parseFloat(cur.kpi.mttr), parseFloat(prev.kpi.mttr)));
      mapSet('#kpi-sla-trend',     trendText(parseInt(cur.kpi.sla),    parseInt(prev.kpi.sla)));
      mapSet('#kpi-open-trend',    trendText(cur.kpi.open,             prev.kpi.open));
      mapSet('#kpi-overdue-trend', trendText(cur.kpi.overdue,          prev.kpi.overdue));

      drawSpark('spark-tickets', cur.tickets);
      drawSpark('spark-frt',     cur.frtHrs);
      drawSpark('spark-mttr',    cur.mttrD);
      drawSpark('spark-sla',     cur.slaPct);
      drawSpark('spark-open',    Array.from({length:days}, ()=> cur.open + Math.round((Math.random()-.5)*8)));
      drawSpark('spark-overdue', Array.from({length:days}, ()=> cur.overdue + Math.round((Math.random()-.5)*4)));

      const mttrScaled = cur.mttrD.map(v=> Math.round(v*15 + 10));
      drawTrend('line-trend', cur.tickets, mttrScaled);

      // ç±»å‹åˆ†å¸ƒ
      const typesRoot = document.getElementById('types-bars');
      if(typesRoot){
        typesRoot.innerHTML = '';
        const list = [
          ['{{ _("è·¯ç¯") }}', Math.round(cur.kpi.tickets*0.26)],
          ['{{ _("ç”µæ¢¯") }}', Math.round(cur.kpi.tickets*0.22)],
          ['{{ _("ä¾›æ°´") }}', Math.round(cur.kpi.tickets*0.18)],
          ['{{ _("é“è·¯") }}', Math.round(cur.kpi.tickets*0.17)],
          ['{{ _("ç»¿åŒ–") }}', Math.round(cur.kpi.tickets*0.17)]
        ];
        const totalType = cur.kpi.tickets || 1;
        list.forEach(([name, val])=>{
          const pct = Math.round(val / totalType * 100);
          const row = document.createElement('div'); row.className='type-row';
          row.innerHTML = `
            <div class="label">${name}</div>
            <div class="bar"><i style="width:${pct}%"></i></div>
            <div class="val">${Number(val).toLocaleString(NUM_LOCALE)}</div>
          `;
          typesRoot.appendChild(row);
        });
      }

      // æœ€æ–°å·¥å•ï¼ˆç¤ºä¾‹ï¼‰â€”â€”çŠ¶æ€ç”¨æœ¬åœ°åŒ–æ˜¾ç¤º
      const body = document.getElementById('latest-body');
      if(body){
        const types = ['{{ _("è·¯ç¯") }}','{{ _("ç”µæ¢¯") }}','{{ _("ä¾›æ°´") }}','{{ _("é“è·¯") }}','{{ _("ç»¿åŒ–") }}'];
        const statusCodes = ['Pending','In Progress','Completed','Rejected'];
        const areas  = ['{{ _("ä¸€ç½‘æ ¼") }}','{{ _("äºŒç½‘æ ¼") }}','{{ _("ä¸œåŒº") }}','{{ _("å—åŒº") }}','{{ _("åŒ—åŒº") }}','{{ _("å›­åŒº") }}'];
        const slaArr = ['24h','48h','72h'];
        body.innerHTML = '';
        for(let i=0;i<10;i++){
          const id = `R${new Date().getFullYear()}-${String(Math.floor(Math.random()*9000)+1000)}`;
          const s  = statusCodes[Math.floor(Math.random()*statusCodes.length)];
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>#${id}</td>
                          <td>${types[Math.floor(Math.random()*types.length)]}</td>
                          <td>${tStatus(s)}</td>
                          <td>${areas[Math.floor(Math.random()*areas.length)]}</td>
                          <td>${slaArr[Math.floor(Math.random()*slaArr.length)]}</td>`;
          body.appendChild(tr);
        }
      }
    }

    document.querySelectorAll('#dashboard .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#dashboard .chip').forEach(b=> b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        render(btn.dataset.range || '7d');
      });
    });

    render('7d');
  })();
  </script>

  <!-- éšè—ç‰¹å®šå†…å®¹ï¼šåªåœ¨é¦–é¡µæ¨¡å¼å±•ç¤ºâ€œå®£ä¼ å†…å®¹å—â€ -->
  <script>
    (function(){
      function showHomeExtras(){
        const isHomeHash = (location.hash === '' || location.hash === '#home');
        const inApp = document.documentElement.classList.contains('app-mode');
        const shouldShow = isHomeHash && !inApp;
        document.querySelectorAll('.extra-content').forEach(el=>{
          el.style.display = shouldShow ? '' : 'none';
        });
      }
      window.addEventListener('hashchange', showHomeExtras);
      document.addEventListener('DOMContentLoaded', showHomeExtras);
    })();
  </script>
</body>
</html>
